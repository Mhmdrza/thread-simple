<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindFlow - Mental Thread Tracker</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/dexie@3.2.3/dist/dexie.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        accent: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            200: '#a7f3d0',
                            300: '#6ee7b7',
                            400: '#34d399',
                            500: '#10b981',
                            600: '#059669',
                            700: '#047857',
                            800: '#065f46',
                            900: '#064e3b',
                        },
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                    },
                },
            },
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        .page-transition {
            transition: all 0.3s ease-in-out;
        }
        
        .page-enter {
            opacity: 0;
            transform: translateY(20px);
        }
        
        .page-enter-active {
            opacity: 1;
            transform: translateY(0);
        }
        
        .page-exit {
            opacity: 1;
        }
        
        .page-exit-active {
            opacity: 0;
            transform: translateY(-20px);
        }
    </style>
</head>
<body class="bg-secondary-50 text-secondary-900">
    <div id="app"></div>
    
    <script type="text/babel">
        // Database setup with Dexie (IndexedDB wrapper)
        const db = new Dexie('MindFlowDB');
        
        db.version(1).stores({
            users: '++id, phoneNumber, name',
            topics: '++id, name, userId, createdAt',
            threads: '++id, title, topicId, userId, isOpen, progress, createdAt, updatedAt',
            threadUpdates: '++id, threadId, content, timestamp',
            actions: '++id, title, description, status, dueDate, threadId, topicId, userId, createdAt, updatedAt',
            actionGenerators: '++id, title, description, frequency, startDate, endDate, userId, topicId, lastGenerated'
        });

        // Initialize database with sample data if empty
        async function initializeDatabase() {
            const userCount = await db.users.count();
            
            if (userCount === 0) {
                const userId = await db.users.add({
                    phoneNumber: '1234567890',
                    name: 'Demo User',
                    createdAt: new Date()
                });
                
                // Create sample topics
                const workTopicId = await db.topics.add({
                    name: 'Work',
                    userId,
                    createdAt: new Date()
                });
                
                const homeTopicId = await db.topics.add({
                    name: 'Household',
                    userId,
                    createdAt: new Date()
                });
                
                const personalTopicId = await db.topics.add({
                    name: 'Personal',
                    userId,
                    createdAt: new Date()
                });
                
                // Create sample threads
                const projectThreadId = await db.threads.add({
                    title: 'Project Alpha',
                    topicId: workTopicId,
                    userId,
                    isOpen: true,
                    progress: 30,
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                
                const homeRenovationThreadId = await db.threads.add({
                    title: 'Kitchen Renovation',
                    topicId: homeTopicId,
                    userId,
                    isOpen: true,
                    progress: 50,
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                
                const learningThreadId = await db.threads.add({
                    title: 'Learn React',
                    topicId: personalTopicId,
                    userId,
                    isOpen: true,
                    progress: 70,
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                
                // Create sample thread updates
                await db.threadUpdates.add({
                    threadId: projectThreadId,
                    content: 'Kickoff meeting completed',
                    timestamp: new Date(Date.now() - 86400000) // 1 day ago
                });
                
                await db.threadUpdates.add({
                    threadId: projectThreadId,
                    content: 'Initial design approved',
                    timestamp: new Date()
                });
                
                await db.threadUpdates.add({
                    threadId: homeRenovationThreadId,
                    content: 'Contacted contractors for quotes',
                    timestamp: new Date(Date.now() - 172800000) // 2 days ago
                });
                
                await db.threadUpdates.add({
                    threadId: homeRenovationThreadId,
                    content: 'Selected materials for countertops',
                    timestamp: new Date()
                });
                
                await db.threadUpdates.add({
                    threadId: learningThreadId,
                    content: 'Completed basic tutorial',
                    timestamp: new Date(Date.now() - 259200000) // 3 days ago
                });
                
                await db.threadUpdates.add({
                    threadId: learningThreadId,
                    content: 'Built first component',
                    timestamp: new Date()
                });
                
                // Create sample actions
                await db.actions.add({
                    title: 'Prepare project timeline',
                    description: 'Create Gantt chart for Project Alpha',
                    status: 'pending',
                    dueDate: new Date(Date.now() + 86400000), // Tomorrow
                    threadId: projectThreadId,
                    topicId: workTopicId,
                    userId,
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                
                await db.actions.add({
                    title: 'Finalize contractor selection',
                    description: 'Review quotes and select the best contractor',
                    status: 'pending',
                    dueDate: new Date(Date.now() + 172800000), // Day after tomorrow
                    threadId: homeRenovationThreadId,
                    topicId: homeTopicId,
                    userId,
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                
                await db.actions.add({
                    title: 'Complete React course chapter 3',
                    description: 'Focus on hooks and state management',
                    status: 'pending',
                    dueDate: new Date(),
                    threadId: learningThreadId,
                    topicId: personalTopicId,
                    userId,
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                
                // Create sample action generators
                await db.actionGenerators.add({
                    title: 'Daily Meditation',
                    description: 'Take 10 minutes to meditate',
                    frequency: '0 8 * * *', // Every day at 8 AM
                    startDate: new Date(),
                    endDate: null, // No end date
                    userId,
                    topicId: personalTopicId,
                    lastGenerated: new Date(Date.now() - 86400000)
                });
                
                await db.actionGenerators.add({
                    title: 'Gym Workout',
                    description: 'Go to gym for 1 hour',
                    frequency: '0 18 * * 1,3,5', // Mon, Wed, Fri at 6 PM
                    startDate: new Date(),
                    endDate: new Date(Date.now() + 30 * 86400000), // 30 days from now
                    userId,
                    topicId: personalTopicId,
                    lastGenerated: new Date(Date.now() - 86400000)
                });
            }
        }
        
        // Initialize database
        initializeDatabase();

        // Utility functions
        function formatDate(date) {
            return new Date(date).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }
        
        function formatTime(date) {
            return new Date(date).toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatDateTime(date) {
            return `${formatDate(date)} at ${formatTime(date)}`;
        }
        
        function calculateTimeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            
            return Math.floor(seconds) + " seconds ago";
        }

        // React Components
        function App() {
            const [currentUser, setCurrentUser] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(true);
            const [currentPage, setCurrentPage] = React.useState('today');
            
            React.useEffect(() => {
                async function fetchUser() {
                    const users = await db.users.toArray();
                    if (users.length > 0) {
                        setCurrentUser(users[0]);
                    }
                    setIsLoading(false);
                }
                
                fetchUser();
            }, []);
            
            if (isLoading) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen p-4">
                        <div className="w-16 h-16 border-4 border-primary-500 border-t-transparent rounded-full animate-spin"></div>
                        <p className="mt-4 text-lg text-secondary-600">Loading MindFlow...</p>
                    </div>
                );
            }
            
            if (!currentUser) {
                return <AuthScreen onLogin={setCurrentUser} />;
            }
            
            return (
                <div className="min-h-screen flex flex-col">
                    <Header user={currentUser} />
                    <main className="flex-1 pb-20">
                        <div className="page-transition">
                            {currentPage === 'today' && <TodayScreen user={currentUser} />}
                            {currentPage === 'threads' && <ThreadsScreen user={currentUser} />}
                            {currentPage === 'generators' && <GeneratorsScreen user={currentUser} />}
                            {currentPage === 'reports' && <ReportsScreen user={currentUser} />}
                        </div>
                    </main>
                    <BottomNav currentPage={currentPage} setCurrentPage={setCurrentPage} />
                </div>
            );
        }
        
        function AuthScreen({ onLogin }) {
            const [phoneNumber, setPhoneNumber] = React.useState('');
            const [name, setName] = React.useState('');
            const [isSignUp, setIsSignUp] = React.useState(false);
            const [error, setError] = React.useState('');
            
            async function handleSubmit(e) {
                e.preventDefault();
                setError('');
                
                if (!phoneNumber) {
                    setError('Phone number is required');
                    return;
                }
                
                if (isSignUp && !name) {
                    setError('Name is required');
                    return;
                }
                
                try {
                    if (isSignUp) {
                        // Check if user already exists
                        const existingUser = await db.users.where({ phoneNumber }).first();
                        
                        if (existingUser) {
                            setError('User with this phone number already exists');
                            return;
                        }
                        
                        // Create new user
                        const userId = await db.users.add({
                            phoneNumber,
                            name,
                            createdAt: new Date()
                        });
                        
                        const newUser = await db.users.get(userId);
                        onLogin(newUser);
                    } else {
                        // Login
                        const user = await db.users.where({ phoneNumber }).first();
                        
                        if (!user) {
                            setError('User not found. Please sign up.');
                            return;
                        }
                        
                        onLogin(user);
                    }
                } catch (error) {
                    setError('An error occurred. Please try again.');
                    console.error(error);
                }
            }
            
            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-b from-primary-50 to-secondary-50">
                    <div className="w-full max-w-md p-6 bg-white rounded-2xl shadow-lg animate-fade-in">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-primary-600">MindFlow</h1>
                            <p className="text-secondary-500 mt-2">Track your mental threads and stay focused</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label htmlFor="phoneNumber" className="block text-sm font-medium text-secondary-700 mb-1">
                                    Phone Number
                                </label>
                                <input
                                    type="tel"
                                    id="phoneNumber"
                                    value={phoneNumber}
                                    onChange={(e) => setPhoneNumber(e.target.value)}
                                    className="w-full px-4 py-3 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="Enter your phone number"
                                />
                            </div>
                            
                            {isSignUp && (
                                <div>
                                    <label htmlFor="name" className="block text-sm font-medium text-secondary-700 mb-1">
                                        Name
                                    </label>
                                    <input
                                        type="text"
                                        id="name"
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                        className="w-full px-4 py-3 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="Enter your name"
                                    />
                                </div>
                            )}
                            
                            {error && (
                                <div className="text-red-500 text-sm py-2">
                                    {error}
                                </div>
                            )}
                            
                            <button
                                type="submit"
                                className="w-full bg-primary-600 hover:bg-primary-700 text-white font-medium py-3 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                            >
                                {isSignUp ? 'Sign Up' : 'Login'}
                            </button>
                        </form>
                        
                        <div className="text-center mt-6">
                            <button
                                onClick={() => setIsSignUp(!isSignUp)}
                                className="text-primary-600 hover:text-primary-800 text-sm font-medium"
                            >
                                {isSignUp ? 'Already have an account? Login' : 'Don\'t have an account? Sign Up'}
                            </button>
                        </div>
                        
                        {/* Demo mode button */}
                        <div className="text-center mt-8 border-t border-secondary-100 pt-6">
                            <button
                                onClick={async () => {
                                    const demoUser = await db.users.where({ phoneNumber: '1234567890' }).first();
                                    if (demoUser) {
                                        onLogin(demoUser);
                                    } else {
                                        await initializeDatabase();
                                        const newDemoUser = await db.users.where({ phoneNumber: '1234567890' }).first();
                                        onLogin(newDemoUser);
                                    }
                                }}
                                className="text-secondary-600 hover:text-secondary-800 text-sm font-medium"
                            >
                                Enter Demo Mode
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
        
        function Header({ user }) {
            return (
                <header className="bg-white shadow-sm">
                    <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                        <div className="flex items-center">
                            <h1 className="text-xl font-bold text-primary-600">MindFlow</h1>
                        </div>
                        <div className="flex items-center space-x-2">
                            <span className="text-sm text-secondary-600">{user.name}</span>
                            <div className="w-8 h-8 rounded-full bg-primary-100 text-primary-600 flex items-center justify-center font-medium">
                                {user.name.charAt(0)}
                            </div>
                        </div>
                    </div>
                </header>
            );
        }
        
        function BottomNav({ currentPage, setCurrentPage }) {
            return (
                <nav className="fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-secondary-100">
                    <div className="flex justify-around items-center h-16">
                        <button
                            onClick={() => setCurrentPage('today')}
                            className={`flex flex-col items-center justify-center w-full h-full ${
                                currentPage === 'today' ? 'text-primary-600' : 'text-secondary-400'
                            }`}
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span className="text-xs mt-1">Today</span>
                        </button>
                        
                        <button
                            onClick={() => setCurrentPage('threads')}
                            className={`flex flex-col items-center justify-center w-full h-full ${
                                currentPage === 'threads' ? 'text-primary-600' : 'text-secondary-400'
                            }`}
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            <span className="text-xs mt-1">Threads</span>
                        </button>
                        
                        <button
                            onClick={() => setCurrentPage('generators')}
                            className={`flex flex-col items-center justify-center w-full h-full ${
                                currentPage === 'generators' ? 'text-primary-600' : 'text-secondary-400'
                            }`}
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                            </svg>
                            <span className="text-xs mt-1">Generators</span>
                        </button>
                        
                        <button
                            onClick={() => setCurrentPage('reports')}
                            className={`flex flex-col items-center justify-center w-full h-full ${
                                currentPage === 'reports' ? 'text-primary-600' : 'text-secondary-400'
                            }`}
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            <span className="text-xs mt-1">Reports</span>
                        </button>
                    </div>
                </nav>
            );
        }
        
        function TodayScreen({ user }) {
            const [actions, setActions] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(true);
            const [showActionModal, setShowActionModal] = React.useState(false);
            const [topics, setTopics] = React.useState([]);
            
            React.useEffect(() => {
                async function fetchData() {
                    try {
                        // Get today's date (start and end)
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const tomorrow = new Date(today);
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        
                        // Fetch today's actions and delayed actions
                        const todayActions = await db.actions
                            .where('userId').equals(user.id)
                            .and(action => {
                                const dueDate = new Date(action.dueDate);
                                dueDate.setHours(0, 0, 0, 0);
                                return dueDate <= today && action.status === 'pending';
                            })
                            .toArray();
                        
                        // Fetch topics for reference
                        const allTopics = await db.topics.where('userId').equals(user.id).toArray();
                        setTopics(allTopics);
                        
                        // Sort actions by due date (oldest first)
                        const sortedActions = todayActions.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                        
                        setActions(sortedActions);
                        setIsLoading(false);
                    } catch (error) {
                        console.error("Error fetching today's actions:", error);
                        setIsLoading(false);
                    }
                }
                
                fetchData();
            }, [user.id]);
            
            async function handleActionUpdate(actionId, status) {
                try {
                    // Update action status
                    await db.actions.update(actionId, {
                        status,
                        updatedAt: new Date()
                    });
                    
                    // If action is completed and associated with a thread, add an update to the thread
                    if (status === 'completed') {
                        const action = await db.actions.get(actionId);
                        
                        if (action.threadId) {
                            await db.threadUpdates.add({
                                threadId: action.threadId,
                                content: `Completed action: ${action.title}`,
                                timestamp: new Date()
                            });
                            
                            // Update thread's updatedAt timestamp
                            await db.threads.update(action.threadId, {
                                updatedAt: new Date()
                            });
                        }
                    }
                    
                    // If action is delayed, update due date to tomorrow
                    if (status === 'delayed') {
                        const tomorrow = new Date();
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        
                        await db.actions.update(actionId, {
                            dueDate: tomorrow
                        });
                    }
                    
                    // Refresh actions list
                    const updatedActions = actions.filter(action => action.id !== actionId);
                    setActions(updatedActions);
                } catch (error) {
                    console.error("Error updating action:", error);
                }
            }
            
            return (
                <div className="max-w-7xl mx-auto px-4 py-6 animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-secondary-900">Today's Actions</h2>
                        <button
                            onClick={() => setShowActionModal(true)}
                            className="bg-primary-600 hover:bg-primary-700 text-white p-2 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                            </svg>
                        </button>
                    </div>
                    
                    <div className="bg-white rounded-xl shadow-sm p-4 mb-4">
                        <div className="text-sm text-secondary-500 mb-2">
                            {new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}
                        </div>
                        <div className="flex items-center">
                            <div className="text-3xl font-bold text-secondary-900">
                                {actions.length}
                            </div>
                            <div className="ml-2 text-secondary-600">
                                {actions.length === 1 ? 'action' : 'actions'} for today
                            </div>
                        </div>
                    </div>
                    
                    {isLoading ? (
                        <div className="flex justify-center py-8">
                            <div className="w-10 h-10 border-4 border-primary-500 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                    ) : actions.length === 0 ? (
                        <div className="bg-white rounded-xl shadow-sm p-6 text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 mx-auto text-secondary-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 className="mt-4 text-lg font-medium text-secondary-900">All caught up!</h3>
                            <p className="mt-2 text-secondary-500">You have no actions for today.</p>
                            <button
                                onClick={() => setShowActionModal(true)}
                                className="mt-4 bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                            >
                                Create New Action
                            </button>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {actions.map(action => {
                                const topic = topics.find(t => t.id === action.topicId);
                                const isOverdue = new Date(action.dueDate) < new Date() && action.dueDate.getDate() !== new Date().getDate();
                                
                                return (
                                    <div key={action.id} className="bg-white rounded-xl shadow-sm overflow-hidden animate-slide-up">
                                        <div className="p-4">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    {topic && (
                                                        <span className="inline-block px-2 py-1 bg-secondary-100 text-secondary-800 text-xs rounded-full mb-2">
                                                            {topic.name}
                                                        </span>
                                                    )}
                                                    <h3 className="text-lg font-semibold text-secondary-900">{action.title}</h3>
                                                    {action.description && (
                                                        <p className="text-secondary-600 text-sm mt-1">{action.description}</p>
                                                    )}
                                                </div>
                                                {isOverdue && (
                                                    <span className="inline-block px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">
                                                        Overdue
                                                    </span>
                                                )}
                                            </div>
                                            
                                            <div className="flex items-center mt-3 text-xs text-secondary-500">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                                Due: {formatDate(action.dueDate)}
                                            </div>
                                        </div>
                                        
                                        <div className="border-t border-secondary-100 grid grid-cols-4 divide-x divide-secondary-100">
                                            <button
                                                onClick={() => handleActionUpdate(action.id, 'completed')}
                                                className="py-3 flex flex-col items-center justify-center text-accent-600 hover:bg-accent-50"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                                </svg>
                                                <span className="text-xs mt-1">Done</span>
                                            </button>
                                            
                                            <button
                                                onClick={() => handleActionUpdate(action.id, 'delayed')}
                                                className="py-3 flex flex-col items-center justify-center text-orange-600 hover:bg-orange-50"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <span className="text-xs mt-1">Delay</span>
                                            </button>
                                            
                                            <button
                                                onClick={() => handleActionUpdate(action.id, 'discarded')}
                                                className="py-3 flex flex-col items-center justify-center text-red-600 hover:bg-red-50"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                                <span className="text-xs mt-1">Discard</span>
                                            </button>
                                            
                                            <button
                                                onClick={() => handleActionUpdate(action.id, 'delegated')}
                                                className="py-3 flex flex-col items-center justify-center text-blue-600 hover:bg-blue-50"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                                </svg>
                                                <span className="text-xs mt-1">Delegate</span>
                                            </button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                    
                    {showActionModal && (
                        <CreateActionModal
                            userId={user.id}
                            onClose={() => setShowActionModal(false)}
                            onActionCreated={(newAction) => {
                                // If action is due today, add it to the list
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);
                                const actionDueDate = new Date(newAction.dueDate);
                                actionDueDate.setHours(0, 0, 0, 0);
                                
                                if (actionDueDate.getTime() === today.getTime()) {
                                    setActions([...actions, newAction]);
                                }
                            }}
                        />
                    )}
                </div>
            );
        }
        
        function CreateActionModal({ userId, onClose, onActionCreated, threadId = null, topicId = null }) {
            const [title, setTitle] = React.useState('');
            const [description, setDescription] = React.useState('');
            const [dueDate, setDueDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [selectedTopicId, setSelectedTopicId] = React.useState(topicId);
            const [selectedThreadId, setSelectedThreadId] = React.useState(threadId);
            const [topics, setTopics] = React.useState([]);
            const [threads, setThreads] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(true);
            
            React.useEffect(() => {
                async function fetchData() {
                    try {
                        // Fetch topics
                        const userTopics = await db.topics.where('userId').equals(userId).toArray();
                        setTopics(userTopics);
                        
                        if (!selectedTopicId && userTopics.length > 0) {
                            setSelectedTopicId(userTopics[0].id);
                        }
                        
                        // Fetch threads for the selected topic
                        if (selectedTopicId) {
                            const topicThreads = await db.threads
                                .where('topicId').equals(selectedTopicId)
                                .and(thread => thread.isOpen)
                                .toArray();
                            setThreads(topicThreads);
                        }
                        
                        setIsLoading(false);
                    } catch (error) {
                        console.error("Error fetching data for action creation:", error);
                        setIsLoading(false);
                    }
                }
                
                fetchData();
            }, [userId, selectedTopicId]);
            
            async function handleTopicChange(e) {
                const newTopicId = parseInt(e.target.value);
                setSelectedTopicId(newTopicId);
                setSelectedThreadId(null);
                
                // Fetch threads for the selected topic
                const topicThreads = await db.threads
                    .where('topicId').equals(newTopicId)
                    .and(thread => thread.isOpen)
                    .toArray();
                setThreads(topicThreads);
            }
            
            async function handleSubmit(e) {
                e.preventDefault();
                
                if (!title || !dueDate || !selectedTopicId) {
                    return;
                }
                
                try {
                    const actionData = {
                        title,
                        description,
                        status: 'pending',
                        dueDate: new Date(dueDate),
                        threadId: selectedThreadId,
                        topicId: selectedTopicId,
                        userId,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    };
                    
                    const actionId = await db.actions.add(actionData);
                    const newAction = await db.actions.get(actionId);
                    
                    // If action is associated with a thread, add an update to the thread
                    if (selectedThreadId) {
                        await db.threadUpdates.add({
                            threadId: selectedThreadId,
                            content: `Created action: ${title}`,
                            timestamp: new Date()
                        });
                        
                        // Update thread's updatedAt timestamp
                        await db.threads.update(selectedThreadId, {
                            updatedAt: new Date()
                        });
                    }
                    
                    onActionCreated(newAction);
                    onClose();
                } catch (error) {
                    console.error("Error creating action:", error);
                }
            }
            
            return (
                <div className="fixed inset-0 bg-secondary-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto animate-slide-up">
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold text-secondary-900">Create New Action</h2>
                                <button
                                    onClick={onClose}
                                    className="text-secondary-400 hover:text-secondary-600"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            
                            {isLoading ? (
                                <div className="flex justify-center py-8">
                                    <div className="w-10 h-10 border-4 border-primary-500 border-t-transparent rounded-full animate-spin"></div>
                                </div>
                            ) : (
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div>
                                        <label htmlFor="title" className="block text-sm font-medium text-secondary-700 mb-1">
                                            Title *
                                        </label>
                                        <input
                                            type="text"
                                            id="title"
                                            value={title}
                                            onChange={(e) => setTitle(e.target.value)}
                                            className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                            placeholder="Enter action title"
                                            required
                                        />
                                    </div>
                                    
                                    <div>
                                        <label htmlFor="description" className="block text-sm font-medium text-secondary-700 mb-1">
                                            Description
                                        </label>
                                        <textarea
                                            id="description"
                                            value={description}
                                            onChange={(e) => setDescription(e.target.value)}
                                            className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                            placeholder="Enter action description"
                                            rows="3"
                                        ></textarea>
                                    </div>
                                    
                                    <div>
                                        <label htmlFor="dueDate" className="block text-sm font-medium text-secondary-700 mb-1">
                                            Due Date *
                                        </label>
                                        <input
                                            type="date"
                                            id="dueDate"
                                            value={dueDate}
                                            onChange={(e) => setDueDate(e.target.value)}
                                            className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                            required
                                        />
                                    </div>
                                    
                                    <div>
                                        <label htmlFor="topic" className="block text-sm font-medium text-secondary-700 mb-1">
                                            Topic *
                                        </label>
                                        <select
                                            id="topic"
                                            value={selectedTopicId || ''}
                                            onChange={handleTopicChange}
                                            className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                            required
                                        >
                                            <option value="">Select a topic</option>
                                            {topics.map(topic => (
                                                <option key={topic.id} value={topic.id}>
                                                    {topic.name}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label htmlFor="thread" className="block text-sm font-medium text-secondary-700 mb-1">
                                            Thread (optional)
                                        </label>
                                        <select
                                            id="thread"
                                            value={selectedThreadId || ''}
                                            onChange={(e) => setSelectedThreadId(e.target.value ? parseInt(e.target.value) : null)}
                                            className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        >
                                            <option value="">None (Topic-level action)</option>
                                            {threads.map(thread => (
                                                <option key={thread.id} value={thread.id}>
                                                    {thread.title}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    
                                    <div className="flex justify-end pt-4">
                                        <button
                                            type="button"
                                            onClick={onClose}
                                            className="px-4 py-2 text-secondary-600 hover:text-secondary-800 mr-2"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                                        >
                                            Create Action
                                        </button>
                                    </div>
                                </form>
                            )}
                        </div>
                    </div>
                </div>
            );
        }
        
        function ThreadsScreen({ user }) {
            const [topics, setTopics] = React.useState([]);
            const [threads, setThreads] = React.useState([]);
            const [threadUpdates, setThreadUpdates] = React.useState({});
            const [actions, setActions] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(true);
            const [showTopicModal, setShowTopicModal] = React.useState(false);
            const [showThreadModal, setShowThreadModal] = React.useState(false);
            const [selectedTopicId, setSelectedTopicId] = React.useState(null);
            const [showThreadUpdateModal, setShowThreadUpdateModal] = React.useState(false);
            const [selectedThreadId, setSelectedThreadId] = React.useState(null);
            const [showActionModal, setShowActionModal] = React.useState(false);
            
            React.useEffect(() => {
                async function fetchData() {
                    try {
                        // Fetch topics
                        const userTopics = await db.topics.where('userId').equals(user.id).toArray();
                        setTopics(userTopics);
                        
                        if (userTopics.length > 0) {
                            const firstTopicId = userTopics[0].id;
                            setSelectedTopicId(firstTopicId);
                        }
                        
                        // Fetch all threads
                        const userThreads = await db.threads.where('userId').equals(user.id).toArray();
                        setThreads(userThreads);
                        
                        // Fetch thread updates for all threads
                        const updates = {};
                        for (const thread of userThreads) {
                            const threadUpdatesList = await db.threadUpdates
                                .where('threadId').equals(thread.id)
                                .reverse()
                                .sortBy('timestamp');
                            updates[thread.id] = threadUpdatesList;
                        }
                        setThreadUpdates(updates);
                        
                        // Fetch pending actions for threads
                        const pendingActions = await db.actions
                            .where('userId').equals(user.id)
                            .and(action => action.status === 'pending')
                            .toArray();
                        setActions(pendingActions);
                        
                        setIsLoading(false);
                    } catch (error) {
                        console.error("Error fetching threads data:", error);
                        setIsLoading(false);
                    }
                }
                
                fetchData();
            }, [user.id]);
            
            function getThreadActions(threadId) {
                return actions.filter(action => action.threadId === threadId);
            }
            
            function getLatestUpdate(threadId) {
                const updates = threadUpdates[threadId] || [];
                return updates.length > 0 ? updates[0] : null;
            }
            
            function handleSelectTopic(topicId) {
                setSelectedTopicId(topicId);
            }
            
            function handleAddThreadUpdate(threadId) {
                setSelectedThreadId(threadId);
                setShowThreadUpdateModal(true);
            }
            
            function handleAddAction(threadId) {
                setSelectedThreadId(threadId);
                setShowActionModal(true);
            }
            
            async function handleToggleThreadStatus(threadId) {
                try {
                    const thread = await db.threads.get(threadId);
                    
                    await db.threads.update(threadId, {
                        isOpen: !thread.isOpen,
                        updatedAt: new Date()
                    });
                    
                    // Update the thread in state
                    setThreads(threads.map(t => {
                        if (t.id === threadId) {
                            return { ...t, isOpen: !t.isOpen };
                        }
                        return t;
                    }));
                    
                    // Add an update to the thread
                    const updateContent = thread.isOpen ? 'Thread closed' : 'Thread reopened';
                    
                    await db.threadUpdates.add({
                        threadId,
                        content: updateContent,
                        timestamp: new Date()
                    });
                    
                    // Update thread updates in state
                    const newUpdate = {
                        threadId,
                        content: updateContent,
                        timestamp: new Date()
                    };
                    
                    setThreadUpdates(prev => ({
                        ...prev,
                        [threadId]: [newUpdate, ...(prev[threadId] || [])]
                    }));
                } catch (error) {
                    console.error("Error toggling thread status:", error);
                }
            }
            
            return (
                <div className="max-w-7xl mx-auto px-4 py-6 animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-secondary-900">Threads & Topics</h2>
                        <div className="flex space-x-2">
                            <button
                                onClick={() => setShowThreadModal(true)}
                                className="bg-primary-600 hover:bg-primary-700 text-white p-2 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                            </button>
                            <button
                                onClick={() => setShowTopicModal(true)}
                                className="bg-secondary-600 hover:bg-secondary-700 text-white p-2 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-secondary-500 focus:ring-offset-2"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    {isLoading ? (
                        <div className="flex justify-center py-8">
                            <div className="w-10 h-10 border-4 border-primary-500 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                    ) : (
                        <>
                            {topics.length === 0 ? (
                                <div className="bg-white rounded-xl shadow-sm p-6 text-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 mx-auto text-secondary-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                                    </svg>
                                    <h3 className="mt-4 text-lg font-medium text-secondary-900">No topics yet</h3>
                                    <p className="mt-2 text-secondary-500">Create your first topic to start organizing your threads.</p>
                                    <button
                                        onClick={() => setShowTopicModal(true)}
                                        className="mt-4 bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                                    >
                                        Create Topic
                                    </button>
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    {/* Topic selector */}
                                    <div className="bg-white rounded-xl shadow-sm p-4">
                                        <div className="flex flex-wrap gap-2">
                                            {topics.map(topic => (
                                                <button
                                                    key={topic.id}
                                                    onClick={() => handleSelectTopic(topic.id)}
                                                    className={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${
                                                        selectedTopicId === topic.id
                                                            ? 'bg-primary-100 text-primary-800'
                                                            : 'bg-secondary-100 text-secondary-700 hover:bg-secondary-200'
                                                    }`}
                                                >
                                                    {topic.name}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* Threads for selected topic */}
                                    <div className="space-y-4">
                                        <div className="flex justify-between items-center">
                                            <h3 className="text-lg font-semibold text-secondary-900">
                                                {selectedTopicId ? topics.find(t => t.id === selectedTopicId)?.name : 'All'} Threads
                                            </h3>
                                            <button
                                                onClick={() => {
                                                    setSelectedTopicId(selectedTopicId);
                                                    setShowThreadModal(true);
                                                }}
                                                className="text-primary-600 hover:text-primary-800 text-sm font-medium flex items-center"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                                </svg>
                                                Add Thread
                                            </button>
                                        </div>
                                        
                                        {threads.filter(thread => thread.topicId === selectedTopicId).length === 0 ? (
                                            <div className="bg-white rounded-xl shadow-sm p-6 text-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 mx-auto text-secondary-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                                </svg>
                                                <h3 className="mt-4 text-lg font-medium text-secondary-900">No threads in this topic</h3>
                                                <p className="mt-2 text-secondary-500">Create your first thread to start tracking your progress.</p>
                                                <button
                                                    onClick={() => {
                                                        setSelectedTopicId(selectedTopicId);
                                                        setShowThreadModal(true);
                                                    }}
                                                    className="mt-4 bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                                                >
                                                    Create Thread
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="space-y-4">
                                                {threads
                                                    .filter(thread => thread.topicId === selectedTopicId)
                                                    .sort((a, b) => {
                                                        // Sort by open status (open first), then by updated date (newest first)
                                                        if (a.isOpen !== b.isOpen) {
                                                            return a.isOpen ? -1 : 1;
                                                        }
                                                        return new Date(b.updatedAt) - new Date(a.updatedAt);
                                                    })
                                                    .map(thread => {
                                                        const latestUpdate = getLatestUpdate(thread.id);
                                                        const threadActions = getThreadActions(thread.id);
                                                        const topic = topics.find(t => t.id === thread.topicId);
                                                        
                                                        return (
                                                            <div key={thread.id} className="bg-white rounded-xl shadow-sm overflow-hidden animate-slide-up">
                                                                <div className="p-4">
                                                                    <div className="flex justify-between items-start">
                                                                        <div>
                                                                            {topic && (
                                                                                <span className="inline-block px-2 py-1 bg-secondary-100 text-secondary-800 text-xs rounded-full mb-2">
                                                                                    {topic.name}
                                                                                </span>
                                                                            )}
                                                                            <h3 className="text-lg font-semibold text-secondary-900 flex items-center">
                                                                                {thread.title}
                                                                                {!thread.isOpen && (
                                                                                    <span className="ml-2 inline-block px-2 py-1 bg-secondary-100 text-secondary-500 text-xs rounded-full">
                                                                                        Closed
                                                                                    </span>
                                                                                )}
                                                                            </h3>
                                                                        </div>
                                                                        <div className="flex items-center">
                                                                            <div className="w-16 h-2 bg-secondary-100 rounded-full overflow-hidden">
                                                                                <div
                                                                                    className="h-full bg-primary-500"
                                                                                    style={{ width: `${thread.progress || 0}%` }}
                                                                                ></div>
                                                                            </div>
                                                                            <span className="ml-2 text-xs text-secondary-500">
                                                                                {thread.progress || 0}%
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {latestUpdate && (
                                                                        <div className="mt-3 p-3 bg-secondary-50 rounded-lg">
                                                                            <div className="text-xs text-secondary-500 mb-1">
                                                                                Latest update • {calculateTimeAgo(latestUpdate.timestamp)}
                                                                            </div>
                                                                            <p className="text-secondary-700 text-sm">
                                                                                {latestUpdate.content}
                                                                            </p>
                                                                        </div>
                                                                    )}
                                                                    
                                                                    {threadActions.length > 0 && (
                                                                        <div className="mt-3">
                                                                            <div className="text-xs text-secondary-500 mb-1">
                                                                                Next action:
                                                                            </div>
                                                                            <div className="flex items-center">
                                                                                <span className="inline-block w-2 h-2 bg-primary-500 rounded-full mr-2"></span>
                                                                                <span className="text-sm text-secondary-700">
                                                                                    {threadActions[0].title}
                                                                                </span>
                                                                                <span className="ml-auto text-xs text-secondary-500">
                                                                                    Due: {formatDate(threadActions[0].dueDate)}
                                                                                </span>
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                                
                                                                <div className="border-t border-secondary-100 grid grid-cols-3 divide-x divide-secondary-100">
                                                                    <button
                                                                        onClick={() => handleAddThreadUpdate(thread.id)}
                                                                        className="py-3 flex items-center justify-center text-primary-600 hover:bg-primary-50"
                                                                    >
                                                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                                        </svg>
                                                                        Update
                                                                    </button>
                                                                    
                                                                    <button
                                                                        onClick={() => handleAddAction(thread.id)}
                                                                        className="py-3 flex items-center justify-center text-accent-600 hover:bg-accent-50"
                                                                    >
                                                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                                                        </svg>
                                                                        Add Action
                                                                    </button>
                                                                    
                                                                    <button
                                                                        onClick={() => handleToggleThreadStatus(thread.id)}
                                                                        className={`py-3 flex items-center justify-center ${
                                                                            thread.isOpen
                                                                                ? 'text-secondary-600 hover:bg-secondary-50'
                                                                                : 'text-green-600 hover:bg-green-50'
                                                                        }`}
                                                                    >
                                                                        {thread.isOpen ? (
                                                                            <>
                                                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                                                </svg>
                                                                                Close
                                                                            </>
                                                                        ) : (
                                                                            <>
                                                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
                                                                                </svg>
                                                                                Reopen
                                                                            </>
                                                                        )}
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </>
                    )}
                    
                    {showTopicModal && (
                        <CreateTopicModal
                            userId={user.id}
                            onClose={() => setShowTopicModal(false)}
                            onTopicCreated={(newTopic) => {
                                setTopics([...topics, newTopic]);
                                setSelectedTopicId(newTopic.id);
                            }}
                        />
                    )}
                    
                    {showThreadModal && (
                        <CreateThreadModal
                            userId={user.id}
                            topics={topics}
                            initialTopicId={selectedTopicId}
                            onClose={() => setShowThreadModal(false)}
                            onThreadCreated={(newThread) => {
                                setThreads([...threads, newThread]);
                                setThreadUpdates({
                                    ...threadUpdates,
                                    [newThread.id]: []
                                });
                            }}
                        />
                    )}
                    
                    {showThreadUpdateModal && (
                        <ThreadUpdateModal
                            threadId={selectedThreadId}
                            thread={threads.find(t => t.id === selectedThreadId)}
                            onClose={() => setShowThreadUpdateModal(false)}
                            onUpdateAdded={(newUpdate) => {
                                setThreadUpdates(prev => ({
                                    ...prev,
                                    [selectedThreadId]: [newUpdate, ...(prev[selectedThreadId] || [])]
                                }));
                                
                                // Update thread's updatedAt timestamp in state
                                setThreads(threads.map(t => {
                                    if (t.id === selectedThreadId) {
                                        return { ...t, updatedAt: new Date() };
                                    }
                                    return t;
                                }));
                            }}
                        />
                    )}
                    
                    {showActionModal && (
                        <CreateActionModal
                            userId={user.id}
                            threadId={selectedThreadId}
                            topicId={threads.find(t => t.id === selectedThreadId)?.topicId}
                            onClose={() => setShowActionModal(false)}
                            onActionCreated={(newAction) => {
                                setActions([...actions, newAction]);
                            }}
                        />
                    )}
                </div>
            );
        }
        
        function CreateTopicModal({ userId, onClose, onTopicCreated }) {
            const [name, setName] = React.useState('');
            const [error, setError] = React.useState('');
            
            async function handleSubmit(e) {
                e.preventDefault();
                setError('');
                
                if (!name) {
                    setError('Topic name is required');
                    return;
                }
                
                try {
                    const topicId = await db.topics.add({
                        name,
                        userId,
                        createdAt: new Date()
                    });
                    
                    const newTopic = await db.topics.get(topicId);
                    onTopicCreated(newTopic);
                    onClose();
                } catch (error) {
                    setError('An error occurred. Please try again.');
                    console.error(error);
                }
            }
            
            return (
                <div className="fixed inset-0 bg-secondary-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md animate-slide-up">
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold text-secondary-900">Create New Topic</h2>
                                <button
                                    onClick={onClose}
                                    className="text-secondary-400 hover:text-secondary-600"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label htmlFor="topicName" className="block text-sm font-medium text-secondary-700 mb-1">
                                        Topic Name *
                                    </label>
                                    <input
                                        type="text"
                                        id="topicName"
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                        className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="Enter topic name"
                                        required
                                    />
                                </div>
                                
                                {error && (
                                    <div className="text-red-500 text-sm py-2">
                                        {error}
                                    </div>
                                )}
                                
                                <div className="flex justify-end pt-4">
                                    <button
                                        type="button"
                                        onClick={onClose}
                                        className="px-4 py-2 text-secondary-600 hover:text-secondary-800 mr-2"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        className="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                                    >
                                        Create Topic
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }
        
        function CreateThreadModal({ userId, topics, initialTopicId, onClose, onThreadCreated }) {
            const [title, setTitle] = React.useState('');
            const [selectedTopicId, setSelectedTopicId] = React.useState(initialTopicId || (topics.length > 0 ? topics[0].id : null));
            const [error, setError] = React.useState('');
            
            async function handleSubmit(e) {
                e.preventDefault();
                setError('');
                
                if (!title) {
                    setError('Thread title is required');
                    return;
                }
                
                if (!selectedTopicId) {
                    setError('Please select a topic');
                    return;
                }
                
                try {
                    const now = new Date();
                    
                    const threadId = await db.threads.add({
                        title,
                        topicId: selectedTopicId,
                        userId,
                        isOpen: true,
                        progress: 0,
                        createdAt: now,
                        updatedAt: now
                    });
                    
                    // Add initial thread update
                    await db.threadUpdates.add({
                        threadId,
                        content: 'Thread created',
                        timestamp: now
                    });
                    
                    const newThread = await db.threads.get(threadId);
                    onThreadCreated(newThread);
                    onClose();
                } catch (error) {
                    setError('An error occurred. Please try again.');
                    console.error(error);
                }
            }
            
            return (
                <div className="fixed inset-0 bg-secondary-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md animate-slide-up">
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold text-secondary-900">Create New Thread</h2>
                                <button
                                    onClick={onClose}
                                    className="text-secondary-400 hover:text-secondary-600"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label htmlFor="threadTitle" className="block text-sm font-medium text-secondary-700 mb-1">
                                        Thread Title *
                                    </label>
                                    <input
                                        type="text"
                                        id="threadTitle"
                                        value={title}
                                        onChange={(e) => setTitle(e.target.value)}
                                        className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="Enter thread title"
                                        required
                                    />
                                </div>
                                
                                <div>
                                    <label htmlFor="topic" className="block text-sm font-medium text-secondary-700 mb-1">
                                        Topic *
                                    </label>
                                    <select
                                        id="topic"
                                        value={selectedTopicId || ''}
                                        onChange={(e) => setSelectedTopicId(parseInt(e.target.value))}
                                        className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        required
                                    >
                                        <option value="">Select a topic</option>
                                        {topics.map(topic => (
                                            <option key={topic.id} value={topic.id}>
                                                {topic.name}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                
                                {error && (
                                    <div className="text-red-500 text-sm py-2">
                                        {error}
                                    </div>
                                )}
                                
                                <div className="flex justify-end pt-4">
                                    <button
                                        type="button"
                                        onClick={onClose}
                                        className="px-4 py-2 text-secondary-600 hover:text-secondary-800 mr-2"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        className="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                                    >
                                        Create Thread
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }
        
        function ThreadUpdateModal({ threadId, thread, onClose, onUpdateAdded }) {
            const [content, setContent] = React.useState('');
            const [progress, setProgress] = React.useState(thread ? thread.progress : 0);
            const [error, setError] = React.useState('');
            
            async function handleSubmit(e) {
                e.preventDefault();
                setError('');
                
                if (!content) {
                    setError('Update content is required');
                    return;
                }
                
                try {
                    const now = new Date();
                    
                    // Add thread update
                    const updateId = await db.threadUpdates.add({
                        threadId,
                        content,
                        timestamp: now
                    });
                    
                    // Update thread progress and updatedAt timestamp
                    await db.threads.update(threadId, {
                        progress,
                        updatedAt: now
                    });
                    
                    const newUpdate = await db.threadUpdates.get(updateId);
                    onUpdateAdded(newUpdate);
                    onClose();
                } catch (error) {
                    setError('An error occurred. Please try again.');
                    console.error(error);
                }
            }
            
            return (
                <div className="fixed inset-0 bg-secondary-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md animate-slide-up">
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold text-secondary-900">Update Thread</h2>
                                <button
                                    onClick={onClose}
                                    className="text-secondary-400 hover:text-secondary-600"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label htmlFor="updateContent" className="block text-sm font-medium text-secondary-700 mb-1">
                                        Update Content *
                                    </label>
                                    <textarea
                                        id="updateContent"
                                        value={content}
                                        onChange={(e) => setContent(e.target.value)}
                                        className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="What's the latest update on this thread?"
                                        rows="4"
                                        required
                                    ></textarea>
                                </div>
                                
                                <div>
                                    <label htmlFor="progress" className="block text-sm font-medium text-secondary-700 mb-1">
                                        Progress: {progress}%
                                    </label>
                                    <input
                                        type="range"
                                        id="progress"
                                        min="0"
                                        max="100"
                                        step="5"
                                        value={progress}
                                        onChange={(e) => setProgress(parseInt(e.target.value))}
                                        className="w-full"
                                    />
                                    <div className="flex justify-between text-xs text-secondary-500 mt-1">
                                        <span>0%</span>
                                        <span>50%</span>
                                        <span>100%</span>
                                    </div>
                                </div>
                                
                                {error && (
                                    <div className="text-red-500 text-sm py-2">
                                        {error}
                                    </div>
                                )}
                                
                                <div className="flex justify-end pt-4">
                                    <button
                                        type="button"
                                        onClick={onClose}
                                        className="px-4 py-2 text-secondary-600 hover:text-secondary-800 mr-2"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        className="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                                    >
                                        Add Update
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }
        
        function GeneratorsScreen({ user }) {
            const [generators, setGenerators] = React.useState([]);
            const [topics, setTopics] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(true);
            const [showGeneratorModal, setShowGeneratorModal] = React.useState(false);
            
            React.useEffect(() => {
                async function fetchData() {
                    try {
                        // Fetch action generators
                        const userGenerators = await db.actionGenerators.where('userId').equals(user.id).toArray();
                        setGenerators(userGenerators);
                        
                        // Fetch topics for reference
                        const userTopics = await db.topics.where('userId').equals(user.id).toArray();
                        setTopics(userTopics);
                        
                        setIsLoading(false);
                    } catch (error) {
                        console.error("Error fetching action generators:", error);
                        setIsLoading(false);
                    }
                }
                
                fetchData();
            }, [user.id]);
            
            function getTopicName(topicId) {
                const topic = topics.find(t => t.id === topicId);
                return topic ? topic.name : 'Unknown Topic';
            }
            
            function formatFrequency(cronExpression) {
                // Simple cron expression formatter
                // This is a very basic implementation and doesn't cover all cases
                try {
                    const parts = cronExpression.split(' ');
                    
                    if (parts.length !== 5) {
                        return cronExpression;
                    }
                    
                    const minute = parts[0];
                    const hour = parts[1];
                    const dayOfMonth = parts[2];
                    const month = parts[3];
                    const dayOfWeek = parts[4];
                    
                    if (dayOfWeek === '*' && dayOfMonth === '*' && month === '*') {
                        // Daily
                        return `Daily at ${hour}:${minute === '0' ? '00' : minute}`;
                    } else if (dayOfMonth === '*' && month === '*' && dayOfWeek !== '*') {
                        // Weekly
                        const days = dayOfWeek.split(',').map(day => {
                            const dayNum = parseInt(day);
                            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                            return dayNames[dayNum];
                        }).join(', ');
                        
                        return `Every ${days} at ${hour}:${minute === '0' ? '00' : minute}`;
                    }
                    
                    return cronExpression;
                } catch (error) {
                    return cronExpression;
                }
            }
            
            async function handleGenerateActions() {
                try {
                    // Get today's date (start and end)
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    
                    let actionsGenerated = 0;
                    
                    for (const generator of generators) {
                        // Check if generator is active
                        const startDate = new Date(generator.startDate);
                        const endDate = generator.endDate ? new Date(generator.endDate) : null;
                        
                        if (startDate > today || (endDate && endDate < today)) {
                            continue; // Generator not active for today
                        }
                        
                        // Check if actions have already been generated for today
                        const lastGenerated = new Date(generator.lastGenerated);
                        lastGenerated.setHours(0, 0, 0, 0);
                        
                        if (lastGenerated.getTime() === today.getTime()) {
                            continue; // Already generated actions for today
                        }
                        
                        // Parse cron expression to check if action should be generated today
                        const cronParts = generator.frequency.split(' ');
                        const dayOfWeek = cronParts[4];
                        
                        // Check if today matches the day of week in cron
                        if (dayOfWeek !== '*') {
                            const todayDayOfWeek = today.getDay().toString();
                            const dayMatches = dayOfWeek.split(',').some(day => day === todayDayOfWeek);
                            
                            if (!dayMatches) {
                                continue; // Not scheduled for today
                            }
                        }
                        
                        // Generate action for today
                        const actionId = await db.actions.add({
                            title: generator.title,
                            description: generator.description,
                            status: 'pending',
                            dueDate: today,
                            threadId: null,
                            topicId: generator.topicId,
                            userId: user.id,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        });
                        
                        // Update generator's lastGenerated timestamp
                        await db.actionGenerators.update(generator.id, {
                            lastGenerated: new Date()
                        });
                        
                        actionsGenerated++;
                    }
                    
                    // Refresh generators list
                    const updatedGenerators = await db.actionGenerators.where('userId').equals(user.id).toArray();
                    setGenerators(updatedGenerators);
                    
                    alert(`Generated ${actionsGenerated} actions for today.`);
                } catch (error) {
                    console.error("Error generating actions:", error);
                    alert("An error occurred while generating actions.");
                }
            }
            
            async function handleDeleteGenerator(generatorId) {
                if (confirm("Are you sure you want to delete this action generator?")) {
                    try {
                        await db.actionGenerators.delete(generatorId);
                        
                        // Refresh generators list
                        setGenerators(generators.filter(g => g.id !== generatorId));
                    } catch (error) {
                        console.error("Error deleting action generator:", error);
                    }
                }
            }
            
            return (
                <div className="max-w-7xl mx-auto px-4 py-6 animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-secondary-900">Action Generators</h2>
                        <div className="flex space-x-2">
                            <button
                                onClick={handleGenerateActions}
                                className="bg-accent-600 hover:bg-accent-700 text-white px-4 py-2 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-accent-500 focus:ring-offset-2 flex items-center"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                                </svg>
                                Generate Today's Actions
                            </button>
                            <button
                                onClick={() => setShowGeneratorModal(true)}
                                className="bg-primary-600 hover:bg-primary-700 text-white p-2 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div className="bg-white rounded-xl shadow-sm p-4 mb-6">
                        <div className="text-sm text-secondary-600 mb-2">
                            Action generators automatically create actions on a schedule.
                        </div>
                        <div className="text-secondary-600">
                            <ul className="list-disc list-inside text-sm space-y-1">
                                <li>Create recurring actions like daily meditation or weekly gym sessions</li>
                                <li>Click "Generate Today's Actions" each day to create scheduled actions</li>
                                <li>Set end dates for temporary habits or leave blank for ongoing ones</li>
                            </ul>
                        </div>
                    </div>
                    
                    {isLoading ? (
                        <div className="flex justify-center py-8">
                            <div className="w-10 h-10 border-4 border-primary-500 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                    ) : generators.length === 0 ? (
                        <div className="bg-white rounded-xl shadow-sm p-6 text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 mx-auto text-secondary-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                            </svg>
                            <h3 className="mt-4 text-lg font-medium text-secondary-900">No action generators yet</h3>
                            <p className="mt-2 text-secondary-500">Create your first action generator to start automating recurring tasks.</p>
                            <button
                                onClick={() => setShowGeneratorModal(true)}
                                className="mt-4 bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                            >
                                Create Action Generator
                            </button>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {generators.map(generator => {
                                const isActive = (!generator.endDate || new Date(generator.endDate) >= new Date()) && 
                                                new Date(generator.startDate) <= new Date();
                                
                                return (
                                    <div key={generator.id} className="bg-white rounded-xl shadow-sm overflow-hidden animate-slide-up">
                                        <div className="p-4">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <span className="inline-block px-2 py-1 bg-secondary-100 text-secondary-800 text-xs rounded-full mb-2">
                                                        {getTopicName(generator.topicId)}
                                                    </span>
                                                    <h3 className="text-lg font-semibold text-secondary-900">{generator.title}</h3>
                                                    {generator.description && (
                                                        <p className="text-secondary-600 text-sm mt-1">{generator.description}</p>
                                                    )}
                                                </div>
                                                <div className="flex flex-col items-end">
                                                    <span className={`inline-block px-2 py-1 text-xs rounded-full ${
                                                        isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                                    }`}>
                                                        {isActive ? 'Active' : 'Inactive'}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <div className="mt-3 grid grid-cols-2 gap-4 text-sm">
                                                <div>
                                                    <div className="text-xs text-secondary-500 mb-1">Frequency</div>
                                                    <div className="text-secondary-700 flex items-center">
                                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1 text-secondary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                        </svg>
                                                        {formatFrequency(generator.frequency)}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div className="text-xs text-secondary-500 mb-1">Duration</div>
                                                    <div className="text-secondary-700 flex items-center">
                                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1 text-secondary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                        </svg>
                                                        {formatDate(generator.startDate)} 
                                                        {generator.endDate ? ` - ${formatDate(generator.endDate)}` : ' - Ongoing'}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div className="mt-3 text-xs text-secondary-500">
                                                Last generated: {generator.lastGenerated ? formatDateTime(generator.lastGenerated) : 'Never'}
                                            </div>
                                        </div>
                                        
                                        <div className="border-t border-secondary-100 flex">
                                            <button
                                                onClick={() => handleDeleteGenerator(generator.id)}
                                                className="py-3 w-full flex items-center justify-center text-red-600 hover:bg-red-50"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                                Delete Generator
                                            </button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                    
                    {showGeneratorModal && (
                        <CreateGeneratorModal
                            userId={user.id}
                            topics={topics}
                            onClose={() => setShowGeneratorModal(false)}
                            onGeneratorCreated={(newGenerator) => {
                                setGenerators([...generators, newGenerator]);
                            }}
                        />
                    )}
                </div>
            );
        }
        
        function CreateGeneratorModal({ userId, topics, onClose, onGeneratorCreated }) {
            const [title, setTitle] = React.useState('');
            const [description, setDescription] = React.useState('');
            const [selectedTopicId, setSelectedTopicId] = React.useState(topics.length > 0 ? topics[0].id : null);
            const [frequency, setFrequency] = React.useState('daily');
            const [customCron, setCustomCron] = React.useState('0 8 * * *'); // Default: daily at 8 AM
            const [selectedDays, setSelectedDays] = React.useState([1, 3, 5]); // Default: Mon, Wed, Fri
            const [startDate, setStartDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [endDate, setEndDate] = React.useState('');
            const [error, setError] = React.useState('');
            
            function handleDayToggle(day) {
                if (selectedDays.includes(day)) {
                    setSelectedDays(selectedDays.filter(d => d !== day));
                } else {
                    setSelectedDays([...selectedDays, day].sort());
                }
            }
            
            function getCronExpression() {
                switch (frequency) {
                    case 'daily':
                        return '0 8 * * *'; // Every day at 8 AM
                    case 'weekdays':
                        return '0 8 * * 1-5'; // Monday to Friday at 8 AM
                    case 'weekends':
                        return '0 8 * * 0,6'; // Saturday and Sunday at 8 AM
                    case 'weekly':
                        return '0 8 * * 1'; // Every Monday at 8 AM
                    case 'monthly':
                        return '0 8 1 * *'; // 1st day of each month at 8 AM
                    case 'custom-days':
                        if (selectedDays.length === 0) {
                            return '0 8 * * *'; // Default to daily if no days selected
                        }
                        return `0 8 * * ${selectedDays.join(',')}`; // Selected days at 8 AM
                    case 'custom':
                        return customCron;
                    default:
                        return '0 8 * * *';
                }
            }
            
            async function handleSubmit(e) {
                e.preventDefault();
                setError('');
                
                if (!title) {
                    setError('Title is required');
                    return;
                }
                
                if (!selectedTopicId) {
                    setError('Please select a topic');
                    return;
                }
                
                if (!startDate) {
                    setError('Start date is required');
                    return;
                }
                
                try {
                    const generatorData = {
                        title,
                        description,
                        frequency: getCronExpression(),
                        startDate: new Date(startDate),
                        endDate: endDate ? new Date(endDate) : null,
                        userId,
                        topicId: selectedTopicId,
                        lastGenerated: null
                    };
                    
                    const generatorId = await db.actionGenerators.add(generatorData);
                    const newGenerator = await db.actionGenerators.get(generatorId);
                    
                    onGeneratorCreated(newGenerator);
                    onClose();
                } catch (error) {
                    setError('An error occurred. Please try again.');
                    console.error(error);
                }
            }
            
            return (
                <div className="fixed inset-0 bg-secondary-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto animate-slide-up">
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold text-secondary-900">Create Action Generator</h2>
                                <button
                                    onClick={onClose}
                                    className="text-secondary-400 hover:text-secondary-600"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label htmlFor="title" className="block text-sm font-medium text-secondary-700 mb-1">
                                        Title *
                                    </label>
                                    <input
                                        type="text"
                                        id="title"
                                        value={title}
                                        onChange={(e) => setTitle(e.target.value)}
                                        className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="Enter action title"
                                        required
                                    />
                                </div>
                                
                                <div>
                                    <label htmlFor="description" className="block text-sm font-medium text-secondary-700 mb-1">
                                        Description
                                    </label>
                                    <textarea
                                        id="description"
                                        value={description}
                                        onChange={(e) => setDescription(e.target.value)}
                                        className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="Enter action description"
                                        rows="2"
                                    ></textarea>
                                </div>
                                
                                <div>
                                    <label htmlFor="topic" className="block text-sm font-medium text-secondary-700 mb-1">
                                        Topic *
                                    </label>
                                    <select
                                        id="topic"
                                        value={selectedTopicId || ''}
                                        onChange={(e) => setSelectedTopicId(parseInt(e.target.value))}
                                        className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        required
                                    >
                                        <option value="">Select a topic</option>
                                        {topics.map(topic => (
                                            <option key={topic.id} value={topic.id}>
                                                {topic.name}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                
                                <div>
                                    <label htmlFor="frequency" className="block text-sm font-medium text-secondary-700 mb-1">
                                        Frequency
                                    </label>
                                    <select
                                        id="frequency"
                                        value={frequency}
                                        onChange={(e) => setFrequency(e.target.value)}
                                        className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    >
                                        <option value="daily">Daily</option>
                                        <option value="weekdays">Weekdays (Mon-Fri)</option>
                                        <option value="weekends">Weekends (Sat-Sun)</option>
                                        <option value="weekly">Weekly (Every Monday)</option>
                                        <option value="monthly">Monthly (1st of each month)</option>
                                        <option value="custom-days">Custom Days</option>
                                        <option value="custom">Custom (Cron Expression)</option>
                                    </select>
                                </div>
                                
                                {frequency === 'custom-days' && (
                                    <div>
                                        <label className="block text-sm font-medium text-secondary-700 mb-1">
                                            Select Days
                                        </label>
                                        <div className="flex flex-wrap gap-2">
                                            {[
                                                { value: 0, label: 'Sun' },
                                                { value: 1, label: 'Mon' },
                                                { value: 2, label: 'Tue' },
                                                { value: 3, label: 'Wed' },
                                                { value: 4, label: 'Thu' },
                                                { value: 5, label: 'Fri' },
                                                { value: 6, label: 'Sat' }
                                            ].map(day => (
                                                <button
                                                    key={day.value}
                                                    type="button"
                                                    onClick={() => handleDayToggle(day.value)}
                                                    className={`px-3 py-1 rounded-full text-sm font-medium transition-colors ${
                                                        selectedDays.includes(day.value)
                                                            ? 'bg-primary-100 text-primary-800'
                                                            : 'bg-secondary-100 text-secondary-700 hover:bg-secondary-200'
                                                    }`}
                                                >
                                                    {day.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {frequency === 'custom' && (
                                    <div>
                                        <label htmlFor="customCron" className="block text-sm font-medium text-secondary-700 mb-1">
                                            Cron Expression
                                        </label>
                                        <input
                                            type="text"
                                            id="customCron"
                                            value={customCron}
                                            onChange={(e) => setCustomCron(e.target.value)}
                                            className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                            placeholder="e.g., 0 8 * * *"
                                        />
                                        <p className="text-xs text-secondary-500 mt-1">
                                            Format: minute hour day-of-month month day-of-week
                                        </p>
                                    </div>
                                )}
                                
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label htmlFor="startDate" className="block text-sm font-medium text-secondary-700 mb-1">
                                            Start Date *
                                        </label>
                                        <input
                                            type="date"
                                            id="startDate"
                                            value={startDate}
                                            onChange={(e) => setStartDate(e.target.value)}
                                            className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label htmlFor="endDate" className="block text-sm font-medium text-secondary-700 mb-1">
                                            End Date (Optional)
                                        </label>
                                        <input
                                            type="date"
                                            id="endDate"
                                            value={endDate}
                                            onChange={(e) => setEndDate(e.target.value)}
                                            className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        />
                                    </div>
                                </div>
                                
                                {error && (
                                    <div className="text-red-500 text-sm py-2">
                                        {error}
                                    </div>
                                )}
                                
                                <div className="flex justify-end pt-4">
                                    <button
                                        type="button"
                                        onClick={onClose}
                                        className="px-4 py-2 text-secondary-600 hover:text-secondary-800 mr-2"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        className="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                                    >
                                        Create Generator
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }
        
        function ReportsScreen({ user }) {
            const [reportType, setReportType] = React.useState('daily');
            const [reportDate, setReportDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [reportData, setReportData] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(false);
            const [topics, setTopics] = React.useState([]);
            
            React.useEffect(() => {
                async function fetchTopics() {
                    const userTopics = await db.topics.where('userId').equals(user.id).toArray();
                    setTopics(userTopics);
                }
                
                fetchTopics();
            }, [user.id]);
            
            React.useEffect(() => {
                generateReport();
            }, [reportType, reportDate]);
            
            async function generateReport() {
                setIsLoading(true);
                
                try {
                    let startDate, endDate;
                    
                    // Calculate date range based on report type
                    const selectedDate = new Date(reportDate);
                    selectedDate.setHours(0, 0, 0, 0);
                    
                    switch (reportType) {
                        case 'daily':
                            startDate = new Date(selectedDate);
                            endDate = new Date(selectedDate);
                            endDate.setHours(23, 59, 59, 999);
                            break;
                        case 'weekly':
                            // Start from Monday of the week containing the selected date
                            startDate = new Date(selectedDate);
                            const day = startDate.getDay();
                            const diff = startDate.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Sunday
                            startDate = new Date(startDate.setDate(diff));
                            
                            // End on Sunday
                            endDate = new Date(startDate);
                            endDate.setDate(startDate.getDate() + 6);
                            endDate.setHours(23, 59, 59, 999);
                            break;
                        case 'monthly':
                            // Start from first day of the month
                            startDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
                            
                            // End on last day of the month
                            endDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0);
                            endDate.setHours(23, 59, 59, 999);
                            break;
                        case 'yearly':
                            // Start from first day of the year
                            startDate = new Date(selectedDate.getFullYear(), 0, 1);
                            
                            // End on last day of the year
                            endDate = new Date(selectedDate.getFullYear(), 11, 31);
                            endDate.setHours(23, 59, 59, 999);
                            break;
                    }
                    
                    // Fetch thread updates within the date range
                    const allThreads = await db.threads.where('userId').equals(user.id).toArray();
                    const threadIds = allThreads.map(thread => thread.id);
                    
                    const updates = await db.threadUpdates
                        .where('threadId').anyOf(threadIds)
                        .and(update => {
                            const updateDate = new Date(update.timestamp);
                            return updateDate >= startDate && updateDate <= endDate;
                        })
                        .toArray();
                    
                    // Fetch actions within the date range
                    const actions = await db.actions
                        .where('userId').equals(user.id)
                        .and(action => {
                            const actionDate = new Date(action.updatedAt);
                            return actionDate >= startDate && actionDate <= endDate;
                        })
                        .toArray();
                    
                    // Group thread updates by thread
                    const threadUpdatesMap = {};
                    updates.forEach(update => {
                        if (!threadUpdatesMap[update.threadId]) {
                            threadUpdatesMap[update.threadId] = [];
                        }
                        threadUpdatesMap[update.threadId].push(update);
                    });
                    
                    // Group actions by status
                    const actionsByStatus = {
                        completed: actions.filter(action => action.status === 'completed'),
                        delayed: actions.filter(action => action.status === 'delayed'),
                        discarded: actions.filter(action => action.status === 'discarded'),
                        delegated: actions.filter(action => action.status === 'delegated'),
                        pending: actions.filter(action => action.status === 'pending')
                    };
                    
                    // Group actions by topic
                    const actionsByTopic = {};
                    actions.forEach(action => {
                        if (!actionsByTopic[action.topicId]) {
                            actionsByTopic[action.topicId] = [];
                        }
                        actionsByTopic[action.topicId].push(action);
                    });
                    
                    // Calculate completion rate
                    const totalActionsWithStatus = actions.filter(action => action.status !== 'pending').length;
                    const completionRate = totalActionsWithStatus > 0 
                        ? Math.round((actionsByStatus.completed.length / totalActionsWithStatus) * 100) 
                        : 0;
                    
                    // Prepare report data
                    setReportData({
                        startDate,
                        endDate,
                        threads: allThreads,
                        threadUpdatesMap,
                        actionsByStatus,
                        actionsByTopic,
                        totalThreadUpdates: updates.length,
                        totalActions: actions.length,
                        completionRate
                    });
                    
                    setIsLoading(false);
                } catch (error) {
                    console.error("Error generating report:", error);
                    setIsLoading(false);
                }
            }
            
            function getTopicName(topicId) {
                const topic = topics.find(t => t.id === topicId);
                return topic ? topic.name : 'Unknown Topic';
            }
            function formatDateRange(start, end) {
                const startFormatted = formatDate(start);
                const endFormatted = formatDate(end);
                
                if (startFormatted === endFormatted) {
                    return startFormatted;
                }
                
                return `${startFormatted} - ${endFormatted}`;
            }
            
            return (
                <div className="max-w-7xl mx-auto px-4 py-6 animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-secondary-900">Reports & Insights</h2>
                    </div>
                    
                    <div className="bg-white rounded-xl shadow-sm p-4 mb-6">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label htmlFor="reportType" className="block text-sm font-medium text-secondary-700 mb-1">
                                    Report Type
                                </label>
                                <select
                                    id="reportType"
                                    value={reportType}
                                    onChange={(e) => setReportType(e.target.value)}
                                    className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                >
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </div>
                            <div>
                                <label htmlFor="reportDate" className="block text-sm font-medium text-secondary-700 mb-1">
                                    Date
                                </label>
                                <input
                                    type="date"
                                    id="reportDate"
                                    value={reportDate}
                                    onChange={(e) => setReportDate(e.target.value)}
                                    className="w-full px-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                />
                            </div>
                        </div>
                    </div>
                    
                    {isLoading ? (
                        <div className="flex justify-center py-8">
                            <div className="w-10 h-10 border-4 border-primary-500 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                    ) : reportData ? (
                        <div className="space-y-6">
                            {/* Report header */}
                            <div className="bg-white rounded-xl shadow-sm p-6">
                                <h3 className="text-lg font-semibold text-secondary-900 mb-4">
                                    Summary for {reportType === 'daily' ? 'Day' : reportType === 'weekly' ? 'Week' : reportType === 'monthly' ? 'Month' : 'Year'}
                                </h3>
                                <div className="text-sm text-secondary-600 mb-4">
                                    {formatDateRange(reportData.startDate, reportData.endDate)}
                                </div>
                                
                                <div className="grid grid-cols-2 gap-6 md:grid-cols-4">
                                    <div className="bg-secondary-50 rounded-lg p-4">
                                        <div className="text-sm text-secondary-500">Thread Updates</div>
                                        <div className="text-2xl font-bold text-secondary-900 mt-1">{reportData.totalThreadUpdates}</div>
                                    </div>
                                    <div className="bg-secondary-50 rounded-lg p-4">
                                        <div className="text-sm text-secondary-500">Total Actions</div>
                                        <div className="text-2xl font-bold text-secondary-900 mt-1">{reportData.totalActions}</div>
                                    </div>
                                    <div className="bg-secondary-50 rounded-lg p-4">
                                        <div className="text-sm text-secondary-500">Completed Actions</div>
                                        <div className="text-2xl font-bold text-accent-600 mt-1">{reportData.actionsByStatus.completed.length}</div>
                                    </div>
                                    <div className="bg-secondary-50 rounded-lg p-4">
                                        <div className="text-sm text-secondary-500">Completion Rate</div>
                                        <div className="text-2xl font-bold text-primary-600 mt-1">{reportData.completionRate}%</div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Actions by status */}
                            <div className="bg-white rounded-xl shadow-sm p-6">
                                <h3 className="text-lg font-semibold text-secondary-900 mb-4">
                                    Actions by Status
                                </h3>
                                
                                {reportData.totalActions === 0 ? (
                                    <div className="text-center py-4 text-secondary-500">
                                        No actions found for this period
                                    </div>
                                ) : (
                                    <>
                                        <div className="h-10 bg-secondary-100 rounded-lg overflow-hidden flex mb-4">
                                            {reportData.totalActions > 0 && (
                                                <>
                                                    <div 
                                                        className="h-full bg-accent-500" 
                                                        style={{ width: `${(reportData.actionsByStatus.completed.length / reportData.totalActions) * 100}%` }}
                                                        title={`Completed: ${reportData.actionsByStatus.completed.length}`}
                                                    ></div>
                                                    <div 
                                                        className="h-full bg-orange-500" 
                                                        style={{ width: `${(reportData.actionsByStatus.delayed.length / reportData.totalActions) * 100}%` }}
                                                        title={`Delayed: ${reportData.actionsByStatus.delayed.length}`}
                                                    ></div>
                                                    <div 
                                                        className="h-full bg-red-500" 
                                                        style={{ width: `${(reportData.actionsByStatus.discarded.length / reportData.totalActions) * 100}%` }}
                                                        title={`Discarded: ${reportData.actionsByStatus.discarded.length}`}
                                                    ></div>
                                                    <div 
                                                        className="h-full bg-blue-500" 
                                                        style={{ width: `${(reportData.actionsByStatus.delegated.length / reportData.totalActions) * 100}%` }}
                                                        title={`Delegated: ${reportData.actionsByStatus.delegated.length}`}
                                                    ></div>
                                                    <div 
                                                        className="h-full bg-secondary-300" 
                                                        style={{ width: `${(reportData.actionsByStatus.pending.length / reportData.totalActions) * 100}%` }}
                                                        title={`Pending: ${reportData.actionsByStatus.pending.length}`}
                                                    ></div>
                                                </>
                                            )}
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-2 md:grid-cols-5 text-sm">
                                            <div className="flex items-center">
                                                <span className="w-3 h-3 bg-accent-500 rounded-full mr-2"></span>
                                                <span>Completed: {reportData.actionsByStatus.completed.length}</span>
                                            </div>
                                            <div className="flex items-center">
                                                <span className="w-3 h-3 bg-orange-500 rounded-full mr-2"></span>
                                                <span>Delayed: {reportData.actionsByStatus.delayed.length}</span>
                                            </div>
                                            <div className="flex items-center">
                                                <span className="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                                                <span>Discarded: {reportData.actionsByStatus.discarded.length}</span>
                                            </div>
                                            <div className="flex items-center">
                                                <span className="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                                                <span>Delegated: {reportData.actionsByStatus.delegated.length}</span>
                                            </div>
                                            <div className="flex items-center">
                                                <span className="w-3 h-3 bg-secondary-300 rounded-full mr-2"></span>
                                                <span>Pending: {reportData.actionsByStatus.pending.length}</span>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                            
                            {/* Actions by topic */}
                            <div className="bg-white rounded-xl shadow-sm p-6">
                                <h3 className="text-lg font-semibold text-secondary-900 mb-4">
                                    Actions by Topic
                                </h3>
                                
                                {Object.keys(reportData.actionsByTopic).length === 0 ? (
                                    <div className="text-center py-4 text-secondary-500">
                                        No actions found for this period
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {Object.entries(reportData.actionsByTopic).map(([topicId, actions]) => (
                                            <div key={topicId} className="border-b border-secondary-100 pb-4 last:border-b-0 last:pb-0">
                                                <div className="flex justify-between items-center mb-2">
                                                    <h4 className="font-medium text-secondary-900">{getTopicName(parseInt(topicId))}</h4>
                                                    <span className="text-sm text-secondary-600">{actions.length} actions</span>
                                                </div>
                                                <div className="text-sm">
                                                    <div className="flex justify-between text-secondary-600 mb-1">
                                                        <span>Completed:</span>
                                                        <span>{actions.filter(a => a.status === 'completed').length}</span>
                                                    </div>
                                                    <div className="h-2 bg-secondary-100 rounded-full overflow-hidden">
                                                        <div 
                                                            className="h-full bg-accent-500" 
                                                            style={{ width: `${(actions.filter(a => a.status === 'completed').length / actions.length) * 100}%` }}
                                                        ></div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            
                            {/* Thread updates */}
                            <div className="bg-white rounded-xl shadow-sm p-6">
                                <h3 className="text-lg font-semibold text-secondary-900 mb-4">
                                    Thread Updates
                                </h3>
                                
                                {reportData.totalThreadUpdates === 0 ? (
                                    <div className="text-center py-4 text-secondary-500">
                                        No thread updates found for this period
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {Object.entries(reportData.threadUpdatesMap).map(([threadId, updates]) => {
                                            const thread = reportData.threads.find(t => t.id === parseInt(threadId));
                                            if (!thread) return null;
                                            
                                            return (
                                                <div key={threadId} className="border-b border-secondary-100 pb-4 last:border-b-0 last:pb-0">
                                                    <h4 className="font-medium text-secondary-900 mb-2">{thread.title}</h4>
                                                    <div className="space-y-2">
                                                        {updates.map(update => (
                                                            <div key={update.id} className="bg-secondary-50 rounded-lg p-3">
                                                                <div className="text-xs text-secondary-500 mb-1">
                                                                    {formatDateTime(update.timestamp)}
                                                                </div>
                                                                <div className="text-sm text-secondary-700">
                                                                    {update.content}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    ) : (
                        <div className="bg-white rounded-xl shadow-sm p-6 text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 mx-auto text-secondary-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            <h3 className="mt-4 text-lg font-medium text-secondary-900">No report data</h3>
                            <p className="mt-2 text-secondary-500">Select a date range to generate a report.</p>
                        </div>
                    )}
                </div>
            );
        }
        
        // Mount the React application
        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<App />);
    </script>
</body>
</html>