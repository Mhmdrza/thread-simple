<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MindFlow</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/idb@7/build/umd.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/idb/7.0.2/idb.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta
      name="description"
      content="A tool for organizing thoughts and actions"
    />
    <meta name="theme-color" content="#4f46e5" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Thinking Tool" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icon-192x192.png" />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                200: "#bae6fd",
                300: "#7dd3fc",
                400: "#38bdf8",
                500: "#0ea5e9",
                600: "#0284c7",
                700: "#0369a1",
                800: "#075985",
                900: "#0c4a6e",
              },
              secondary: {
                50: "#f8fafc",
                100: "#f1f5f9",
                200: "#e2e8f0",
                300: "#cbd5e1",
                400: "#94a3b8",
                500: "#64748b",
                600: "#475569",
                700: "#334155",
                800: "#1e293b",
                900: "#0f172a",
              },
              accent: {
                50: "#f0fdf4",
                100: "#dcfce7",
                200: "#bbf7d0",
                300: "#86efac",
                400: "#4ade80",
                500: "#22c55e",
                600: "#16a34a",
                700: "#15803d",
                800: "#166534",
                900: "#14532d",
              },
            },
            animation: {
              "fade-in": "fadeIn 0.3s ease-in-out",
              "slide-up": "slideUp 0.3s ease-in-out",
            },
            keyframes: {
              fadeIn: {
                "0%": { opacity: 0 },
                "100%": { opacity: 1 },
              },
              slideUp: {
                "0%": { transform: "translateY(20px)", opacity: 0 },
                "100%": { transform: "translateY(0)", opacity: 1 },
              },
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        overflow-x: hidden;
      }

      /* System dark mode support */
      @media (prefers-color-scheme: dark) {
        .dark-mode {
          --bg-color: #0f172a;
          --text-color: #f8fafc;
          --card-bg: #1e293b;
          --border-color: #334155;
        }

        body {
          background-color: var(--bg-color);
          color: var(--text-color);
        }

        .dark-card {
          background-color: var(--card-bg);
          border-color: var(--border-color);
        }

        .dark-border {
          border-color: var(--border-color);
        }

        .dark-text {
          color: var(--text-color);
        }

        .dark-input {
          background-color: #1e293b;
          border-color: #334155;
          color: #f8fafc;
        }

        .dark-input::placeholder {
          color: #64748b;
        }
      }
    </style>
  </head>
  <body class="dark-mode">
    <div id="app"></div>

    <script type="text/babel">
      // services/database.js
      const DB_NAME = "mindflow_db";
      const DB_VERSION = 2; // Increased version to handle schema updates

      async function initDB() {
        return idb.openDB(DB_NAME, DB_VERSION, {
          upgrade(db, oldVersion, newVersion, transaction) {
            // Topics store
            if (!db.objectStoreNames.contains("topics")) {
              const topicsStore = db.createObjectStore("topics", {
                keyPath: "id",
                autoIncrement: true,
              });
              topicsStore.createIndex("name", "name", { unique: true });

              // Add default topics
              topicsStore.add({ id: 1, name: "All", color: "#0ea5e9" });
              topicsStore.add({ id: 2, name: "Personal", color: "#22c55e" });
              topicsStore.add({ id: 3, name: "Work", color: "#f97316" });
              topicsStore.add({ id: 4, name: "Ideas", color: "#8b5cf6" });
            }

            // Threads store
            if (!db.objectStoreNames.contains("threads")) {
              const threadsStore = db.createObjectStore("threads", {
                keyPath: "id",
                autoIncrement: true,
              });
              threadsStore.createIndex("topicId", "topicId");
              threadsStore.createIndex("createdAt", "createdAt");
              threadsStore.createIndex("state", "state", { unique: false });
            }

            // Thread updates store
            if (!db.objectStoreNames.contains("threadUpdates")) {
              const updatesStore = db.createObjectStore("threadUpdates", {
                keyPath: "id",
                autoIncrement: true,
              });
              updatesStore.createIndex("threadId", "threadId");
              updatesStore.createIndex("timestamp", "timestamp");
            }

            // Thread actions store - modified with order field for sequence
            if (!db.objectStoreNames.contains("actions")) {
              const actionsStore = db.createObjectStore("actions", {
                keyPath: "id",
                autoIncrement: true,
              });
              actionsStore.createIndex("threadId", "threadId");
              actionsStore.createIndex("topicId", "topicId");
              actionsStore.createIndex("status", "status");
              actionsStore.createIndex("due", "due");
              actionsStore.createIndex("createdAt", "createdAt");
              actionsStore.createIndex("order", "order"); // To maintain action sequence
            } else if (oldVersion === 1) {
              // Add the order index to existing actions store if upgrading from v1
              const actionsStore = transaction.objectStore("actions");
              if (!actionsStore.indexNames.contains("order")) {
                actionsStore.createIndex("order", "order");
              }
            }

            // Action generators store
            if (!db.objectStoreNames.contains("actionGenerators")) {
              const generatorsStore = db.createObjectStore("actionGenerators", {
                keyPath: "id",
                autoIncrement: true,
              });
              generatorsStore.createIndex("topicId", "topicId");
              generatorsStore.createIndex("frequency", "frequency");
            }
          },
        });
      }
      // hooks/useDatabase.js
      function useDatabase() {
        const [db, setDb] = React.useState(null);
        const [loading, setLoading] = React.useState(true);

        React.useEffect(() => {
          async function setupDb() {
            const database = await initDB();
            setDb(database);
            setLoading(false);
          }
          setupDb();
        }, []);

        return { db, loading };
      }

      // hooks/useTopics.js
      function useTopics(db) {
        const [topics, setTopics] = React.useState([]);
        const [loading, setLoading] = React.useState(true);

        React.useEffect(() => {
          if (!db) return;

          async function loadTopics() {
            const allTopics = await db.getAll("topics");
            setTopics(allTopics);
            setLoading(false);
          }

          loadTopics();
        }, [db]);

        return { topics, loading };
      }

      // hooks/useThreads.js
      function useThreads(db, topicId = 0) {
        const [threads, setThreads] = React.useState([]);
        const [loading, setLoading] = React.useState(true);

        const loadThreads = React.useCallback(async () => {
          setLoading(true);
          let allThreads;

          if (topicId === 0) {
            allThreads = await db.getAll("threads");
          } else {
            const index = db.transaction("threads").store.index("topicId");
            allThreads = await index.getAll(IDBKeyRange.only(topicId));
          }

          const threadsWithUpdates = await Promise.all(
            allThreads.map(async (thread) => {
              const index = db
                .transaction("threadUpdates")
                .store.index("threadId");
              const updates = await index.getAll(IDBKeyRange.only(thread.id));
              updates.sort(
                (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
              );

              return {
                ...thread,
                latestUpdate: updates[0] || null,
              };
            })
          );

          threadsWithUpdates.sort((a, b) => {
            const dateA = a.latestUpdate
              ? new Date(a.latestUpdate.timestamp)
              : new Date(a.createdAt);
            const dateB = b.latestUpdate
              ? new Date(b.latestUpdate.timestamp)
              : new Date(b.createdAt);
            return dateB - dateA;
          });

          setThreads(threadsWithUpdates);
          setLoading(false);
        }, [db, topicId]);

        React.useEffect(() => {
          if (!db) return;
          loadThreads();
        }, [db, topicId, loadThreads]);

        return { threads, loading, loadThreads };
      }

      // hooks/useActions.js
      function useActions(db, topicId = 0) {
        const [actions, setActions] = React.useState([]);
        const [loading, setLoading] = React.useState(true);

        const loadActions = React.useCallback(async () => {
          setLoading(true);
          let actionsList;

          if (topicId === 0) {
            // Get standalone actions
            const index = db.transaction("actions").store.index("status");
            const standardActions = await index.getAll(
              IDBKeyRange.only("pending")
            );

            // Get only the first pending action from each thread
            const threadActions = await getFirstPendingThreadActions(db);

            // Combine them
            actionsList = [...standardActions, ...threadActions];
          } else {
            const index = db.transaction("actions").store.index("topicId");
            actionsList = await index.getAll(IDBKeyRange.only(topicId));
            actionsList = actionsList.filter(
              (action) => action.status === "pending"
            );
          }

          const oneDayAgo = new Date();
          oneDayAgo.setDate(oneDayAgo.getDate() - 1);

          const processedActions = actionsList.map((action) => {
            const createdAt = new Date(action.createdAt);
            if (createdAt < oneDayAgo && action.status === "pending") {
              return { ...action, untouched: true };
            }
            return action;
          });

          setActions(processedActions);
          setLoading(false);
        }, [db, topicId]);

        React.useEffect(() => {
          if (!db) return;
          loadActions();
        }, [db, topicId, loadActions]);

        // Helper function to get only first pending action from each thread
        async function getFirstPendingThreadActions(db) {
          const threads = await db.getAll("threads");
          const result = [];

          for (const thread of threads) {
            const index = db.transaction("actions").store.index("threadId");
            const threadActions = await index.getAll(
              IDBKeyRange.only(thread.id)
            );

            // Sort by order to ensure we get the earliest action in sequence
            threadActions.sort((a, b) => (a.order || 0) - (b.order || 0));

            // Find the first pending action
            const firstPending = threadActions.find(
              (a) => a.status === "pending"
            );
            if (firstPending) {
              result.push({
                ...firstPending,
                threadTitle: thread.title, // Include thread title for UI
              });
            }
          }

          return result;
        }

        const handleActionStatusChange = async (actionId, newStatus) => {
          const action = await db.get("actions", actionId);
          action.status = newStatus;
          action.completedAt =
            newStatus === "completed" ? new Date().toISOString() : null;
          await db.put("actions", action);

          // Reload actions to show the next pending action if this was part of a thread
          await loadActions();
        };

        return { actions, loading, handleActionStatusChange, loadActions };
      }

      // hooks/useThreadActions.js
      function useThreadActions(db, threadId) {
        const [actions, setActions] = React.useState([]);
        const [loading, setLoading] = React.useState(true);

        const loadThreadActions = React.useCallback(async () => {
          if (!threadId) return;

          setLoading(true);
          const index = db.transaction("actions").store.index("threadId");
          const threadActions = await index.getAll(IDBKeyRange.only(threadId));

          // Sort by order to maintain sequence
          threadActions.sort((a, b) => (a.order || 0) - (b.order || 0));
          setActions(threadActions);
          setLoading(false);
        }, [db, threadId]);

        React.useEffect(() => {
          if (!db || !threadId) return;
          loadThreadActions();
        }, [db, threadId, loadThreadActions]);

        const addThreadAction = async (text) => {
          // Find the highest order value
          const maxOrder =
            actions.length > 0
              ? Math.max(...actions.map((a) => a.order || 0))
              : -1;

          const newAction = {
            text,
            threadId,
            status: "pending",
            createdAt: new Date().toISOString(),
            order: maxOrder + 1, // Set next in sequence
          };

          await db.add("actions", newAction);
          await loadThreadActions(); // Reload to get updated list with proper order
        };

        const updateActionStatus = async (actionId, newStatus) => {
          const action = await db.get("actions", actionId);
          action.status = newStatus;
          action.completedAt = ["completed", "discarded", "delegated"].includes(
            newStatus
          )
            ? new Date().toISOString()
            : null;
          await db.put("actions", action);

          await loadThreadActions();
        };

        return { actions, loading, addThreadAction, updateActionStatus };
      } // components/BottomNav.js
      function BottomNav({ currentView, navigateTo }) {
        return (
          <div className="fixed bottom-0 w-full bg-white dark:bg-secondary-800 border-t border-secondary-200 dark:border-secondary-700 shadow-lg z-50">
            <div className="flex justify-around max-w-md mx-auto">
              <NavButton
                icon="home"
                label="Home"
                isActive={currentView === "home"}
                onClick={() => navigateTo("home")}
              />
              <NavButton
                icon="actions"
                label="Actions"
                isActive={currentView === "actions"}
                onClick={() => navigateTo("actions")}
              />
              <NavButton
                icon="generators"
                label="Generators"
                isActive={currentView === "actionGenerators"}
                onClick={() => navigateTo("actionGenerators")}
              />
              <NavButton
                icon="reports"
                label="Reports"
                isActive={currentView === "reports"}
                onClick={() => navigateTo("reports")}
              />
              <NavButton
                icon="topics"
                label="Topics"
                isActive={currentView === "topics"}
                onClick={() => navigateTo("topics")}
              />
            </div>
          </div>
        );
      }

      // components/NavButton.js
      function NavButton({ icon, label, isActive, onClick }) {
        let iconElement;

        switch (icon) {
          case "home":
            iconElement = (
              <svg
                xmlns="http://www.w3.org/2000/svg"
                className="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
                />
              </svg>
            );
            break;
          // ...other icons
        }

        return (
          <button
            onClick={onClick}
            className={`flex flex-col items-center p-3 w-full ${
              isActive
                ? "text-primary-600 dark:text-primary-400"
                : "text-secondary-500 dark:text-secondary-400"
            }`}
          >
            {iconElement}
            <span className="text-xs">{label}</span>
          </button>
        );
      }

      // components/TopicFilter.js
      function TopicFilter({ topics, selectedTopic, onSelectTopic }) {
        return (
          <div className="overflow-x-auto pb-3 mb-4">
            <div className="flex space-x-2 w-max">
              <button
                onClick={() => onSelectTopic(0)}
                className={`px-4 py-2 rounded-full text-sm font-medium transition ${
                  selectedTopic === 0
                    ? "bg-primary-100 text-primary-800 dark:bg-primary-800 dark:text-primary-100"
                    : "bg-white text-secondary-700 dark:bg-secondary-800 dark:text-secondary-300"
                } shadow-sm`}
              >
                All Topics
              </button>

              {topics.map((topic) => (
                <button
                  key={topic.id}
                  onClick={() => onSelectTopic(topic.id)}
                  className={`px-4 py-2 rounded-full text-sm font-medium transition ${
                    selectedTopic === topic.id
                      ? "bg-primary-100 text-primary-800 dark:bg-primary-800 dark:text-primary-100"
                      : "bg-white text-secondary-700 dark:bg-secondary-800 dark:text-secondary-300"
                  } shadow-sm`}
                  style={
                    selectedTopic === topic.id
                      ? {
                          backgroundColor: `${topic.color}20`,
                          color: topic.color,
                        }
                      : {}
                  }
                >
                  {topic.name}
                </button>
              ))}
            </div>
          </div>
        );
      }

      // components/ActionItem.js
      function ActionItem({ action, topic, onStatusChange, navigateToThread }) {
        return (
          <div
            className={`bg-white dark:bg-secondary-800 rounded-lg shadow-sm p-4 flex items-center border-l-4 ${
              action.untouched
                ? "border-red-500"
                : "border-secondary-300 dark:border-secondary-600"
            }`}
          >
            <button
              onClick={() => onStatusChange(action.id, "completed")}
              className="w-6 h-6 rounded-full border-2 border-secondary-300 dark:border-secondary-500 hover:border-accent-500 dark:hover:border-accent-400 mr-3 flex-shrink-0"
              aria-label="Mark as completed"
            ></button>
            <div className="flex-grow">
              <p className="text-secondary-900 dark:text-secondary-100 line-clamp-2">
                {action.text}
              </p>

              {/* If this is a thread action, show the thread title and link */}
              {action.threadId && action.threadTitle && (
                <button
                  onClick={() => navigateToThread(action.threadId)}
                  className="text-xs text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300 flex items-center"
                >
                  From thread: {action.threadTitle}
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    className="h-3 w-3 ml-1"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M9 5l7 7-7 7"
                    />
                  </svg>
                </button>
              )}

              {action.untouched && (
                <span className="text-xs font-medium text-red-600 dark:text-red-400">
                  Untouched for over a day
                </span>
              )}

              {topic && (
                <span
                  className="text-xs px-2 py-0.5 rounded-full ml-2"
                  style={{
                    backgroundColor: `${topic.color}20`,
                    color: topic.color,
                  }}
                >
                  {topic.name}
                </span>
              )}
            </div>
            <div className="flex space-x-1 ml-2">
              <button
                onClick={() => onStatusChange(action.id, "delayed")}
                className="text-orange-500 hover:text-orange-600 dark:hover:text-orange-400 p-2"
                title="Delay"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  className="h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </button>
              <button
                onClick={() => onStatusChange(action.id, "discarded")}
                className="text-red-500 hover:text-red-600 dark:hover:text-red-400 p-2"
                title="Discard"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  className="h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                  />
                </svg>
              </button>
            </div>
          </div>
        );
      } // components/ThreadActions.js
      function ThreadActions({ db, threadId }) {
        const { actions, loading, addThreadAction, updateActionStatus } =
          useThreadActions(db, threadId);
        const [newActionText, setNewActionText] = React.useState("");

        const handleAddAction = async (e) => {
          e.preventDefault();
          if (!newActionText.trim()) return;

          await addThreadAction(newActionText);
          setNewActionText("");
        };

        if (loading) {
          return <LoadingSpinner size="md" />;
        }

        return (
          <div className="mt-6">
            <h3 className="text-lg font-medium text-secondary-900 dark:text-secondary-100 mb-4">
              Thread Actions
            </h3>

            {/* Vertical stepper for thread actions */}
            <div className="relative pl-8 mb-6">
              {actions.length > 0 && (
                <div className="absolute top-0 bottom-0 left-3 w-0.5 bg-secondary-200 dark:bg-secondary-700"></div>
              )}

              {actions.map((action, index) => {
                // Find the first pending action index
                const firstPendingIndex = actions.findIndex(
                  (a) => a.status === "pending"
                );

                // Determine if this action is the current active step
                const isCurrent =
                  action.status === "pending" && index === firstPendingIndex;

                return (
                  <div key={action.id} className="mb-6 relative">
                    {/* Status indicator dot */}
                    <div
                      className={`absolute left-3 transform -translate-x-1/2 -translate-y-1/2 w-6 h-6 rounded-full flex items-center justify-center z-10 ${
                        action.status === "completed"
                          ? "bg-accent-500 text-white"
                          : isCurrent
                          ? "bg-primary-500 text-white"
                          : action.status === "pending"
                          ? "bg-white dark:bg-secondary-800 border-2 border-primary-500 dark:border-primary-400"
                          : "bg-secondary-100 dark:bg-secondary-700 text-secondary-500 dark:text-secondary-400"
                      }`}
                    >
                      {action.status === "completed" && (
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          className="h-4 w-4"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                        >
                          <path
                            fillRule="evenodd"
                            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                            clipRule="evenodd"
                          />
                        </svg>
                      )}
                      {action.status === "discarded" && (
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          className="h-4 w-4"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                        >
                          <path
                            fillRule="evenodd"
                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                            clipRule="evenodd"
                          />
                        </svg>
                      )}
                      {action.status === "delegated" && (
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          className="h-4 w-4"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                        >
                          <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 00-6 6H2a8 8 0 0116 0h-2a6 6 0 00-6-6z" />
                        </svg>
                      )}
                    </div>

                    {/* Action content */}
                    <div
                      className={`pl-6 ${
                        action.status === "completed"
                          ? "text-secondary-500 dark:text-secondary-400 line-through"
                          : isCurrent
                          ? "text-secondary-900 dark:text-secondary-100 font-medium"
                          : action.status === "pending"
                          ? "text-secondary-700 dark:text-secondary-300"
                          : "text-secondary-500 dark:text-secondary-400"
                      }`}
                    >
                      <p>{action.text}</p>

                      {action.status === "pending" && (
                        <div className="mt-2 flex space-x-2">
                          <button
                            onClick={() =>
                              updateActionStatus(action.id, "completed")
                            }
                            className="px-2 py-1 text-xs font-medium rounded bg-accent-100 text-accent-700 dark:bg-accent-900 dark:text-accent-300 hover:bg-accent-200 dark:hover:bg-accent-800"
                          >
                            Complete
                          </button>
                          <button
                            onClick={() =>
                              updateActionStatus(action.id, "discarded")
                            }
                            className="px-2 py-1 text-xs font-medium rounded bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-800"
                          >
                            Discard
                          </button>
                          <button
                            onClick={() =>
                              updateActionStatus(action.id, "delegated")
                            }
                            className="px-2 py-1 text-xs font-medium rounded bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300 hover:bg-orange-200 dark:hover:bg-orange-800"
                          >
                            Delegate
                          </button>
                        </div>
                      )}

                      {action.status !== "pending" && (
                        <span className="text-xs text-secondary-500 dark:text-secondary-400">
                          {action.status}{" "}
                          {action.completedAt
                            ? `on ${new Date(
                                action.completedAt
                              ).toLocaleDateString()}`
                            : ""}
                        </span>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Add new action form */}
            <form onSubmit={handleAddAction} className="mt-4">
              <div className="flex flex-col space-y-2">
                <input
                  type="text"
                  value={newActionText}
                  onChange={(e) => setNewActionText(e.target.value)}
                  placeholder="Add a new action step..."
                  className="px-4 py-2 border border-secondary-200 dark:border-secondary-700 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-secondary-800 dark:text-white"
                />
                <button
                  type="submit"
                  className="px-4 py-2 bg-primary-500 text-white rounded-md hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                >
                  Add Action
                </button>
              </div>
            </form>
          </div>
        );
      } // components/ThreadDetail.js
      function ThreadDetail({ db, thread, navigateTo }) {
        const [currentThread, setCurrentThread] = React.useState(thread);
        const [updates, setUpdates] = React.useState([]);
        const [topics, setTopics] = React.useState([]);
        const [loading, setLoading] = React.useState(true);
        const [newUpdate, setNewUpdate] = React.useState("");

        React.useEffect(() => {
          async function loadData() {
            setLoading(true);

            // Load the thread data
            const threadData = await db.get("threads", thread.id);
            setCurrentThread(threadData);

            // Load thread updates
            const index = db
              .transaction("threadUpdates")
              .store.index("threadId");
            const updateData = await index.getAll(IDBKeyRange.only(thread.id));
            updateData.sort(
              (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
            );
            setUpdates(updateData);

            // Load topics
            const topicsData = await db.getAll("topics");
            setTopics(topicsData);

            setLoading(false);
          }

          loadData();
        }, [db, thread.id]);

        const handleAddUpdate = async (e) => {
          e.preventDefault();
          if (!newUpdate.trim()) return;

          const update = {
            threadId: thread.id,
            content: newUpdate,
            timestamp: new Date().toISOString(),
          };

          const id = await db.add("threadUpdates", update);
          const newUpdateWithId = { ...update, id };
          setUpdates([newUpdateWithId, ...updates]);
          setNewUpdate("");
        };

        const handleStateChange = async (e) => {
          const newState = e.target.value;
          const updatedThread = { ...currentThread, state: newState };
          await db.put("threads", updatedThread);
          setCurrentThread(updatedThread);
        };

        const handleTopicChange = async (e) => {
          const topicId = parseInt(e.target.value);
          const updatedThread = { ...currentThread, topicId };
          await db.put("threads", updatedThread);
          setCurrentThread(updatedThread);
        };

        if (loading) {
          return <LoadingSpinner />;
        }

        return (
          <div className="max-w-2xl mx-auto px-4 py-6 animate-fade-in">
            <button
              onClick={() => navigateTo("home")}
              className="mb-4 flex items-center text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                className="h-5 w-5 mr-1"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fillRule="evenodd"
                  d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                  clipRule="evenodd"
                />
              </svg>
              Back
            </button>

            <div className="bg-white dark:bg-secondary-800 rounded-xl shadow-sm p-6">
              {/* Thread header */}
              <div className="flex justify-between items-start mb-4">
                <h1 className="text-2xl font-bold text-secondary-900 dark:text-secondary-100">
                  {currentThread.title}
                </h1>

                <div className="flex space-x-2">
                  <select
                    value={currentThread.state || "open"}
                    onChange={handleStateChange}
                    className="px-2 py-1 text-sm border border-secondary-200 dark:border-secondary-700 rounded dark:bg-secondary-700 dark:text-white"
                  >
                    <option value="open">Open</option>
                    <option value="blocked">Blocked</option>
                    <option value="completed">Completed</option>
                  </select>

                  <select
                    value={currentThread.topicId}
                    onChange={handleTopicChange}
                    className="px-2 py-1 text-sm border border-secondary-200 dark:border-secondary-700 rounded dark:bg-secondary-700 dark:text-white"
                  >
                    {topics.map((topic) => (
                      <option key={topic.id} value={topic.id}>
                        {topic.name}
                      </option>
                    ))}
                  </select>
                </div>
              </div>

              {/* Thread actions component */}
              <ThreadActions db={db} threadId={thread.id} />

              {/* Thread updates section */}
              <div className="mt-8 border-t border-secondary-200 dark:border-secondary-700 pt-6">
                <h2 className="text-lg font-medium text-secondary-900 dark:text-secondary-100 mb-4">
                  Thread Updates
                </h2>

                <form onSubmit={handleAddUpdate} className="mb-6">
                  <textarea
                    value={newUpdate}
                    onChange={(e) => setNewUpdate(e.target.value)}
                    placeholder="Add an update to this thread..."
                    className="w-full px-4 py-2 border border-secondary-300 dark:border-secondary-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-secondary-800 dark:text-white"
                    rows="3"
                  ></textarea>
                  <button
                    type="submit"
                    className="mt-2 px-4 py-2 bg-primary-500 text-white rounded-md hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                  >
                    Add Update
                  </button>
                </form>

                {updates.length > 0 ? (
                  <div className="space-y-4">
                    {updates.map((update) => (
                      <div
                        key={update.id}
                        className="p-4 bg-secondary-50 dark:bg-secondary-900 rounded-lg"
                      >
                        <div className="text-xs text-secondary-500 dark:text-secondary-400 mb-1">
                          {new Date(update.timestamp).toLocaleString()}
                        </div>
                        <p className="text-secondary-900 dark:text-secondary-100">
                          {update.content}
                        </p>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p className="text-center text-secondary-500 dark:text-secondary-400 py-4">
                    No updates yet
                  </p>
                )}
              </div>
            </div>
          </div>
        );
      }
      function App() {
        const { db, loading } = useDatabase();
        const [view, setView] = React.useState("action");
        const [currentThread, setCurrentThread] = React.useState(null);
        const [currentAction, setCurrentAction] = React.useState(null);

        if (loading) {
          return (
            <div className="flex h-screen items-center justify-center">
              <div className="w-12 h-12 border-4 border-primary-500 border-t-transparent rounded-full animate-spin"></div>
            </div>
          );
        }

        // Navigation handler
        const navigateTo = (newView, data = null) => {
          if (newView === "thread" && data) {
            setCurrentThread(data);
          } else if (newView === "action" && data) {
            setCurrentAction(data);
          }
          setView(newView);
          window.scrollTo(0, 0);
        };

        // Render the current view
        const renderView = () => {
          switch (view) {
            case "home":
              return <Home db={db} navigateTo={navigateTo} />;
            case "thread":
              return (
                <ThreadDetail
                  db={db}
                  thread={currentThread}
                  navigateTo={navigateTo}
                />
              );
            case "action":
              return (
                <ActionDetail
                  db={db}
                  action={currentAction}
                  navigateTo={navigateTo}
                />
              );
            case "newThread":
              return <NewThread db={db} navigateTo={navigateTo} />;
            case "actions":
              return <ActionsList db={db} navigateTo={navigateTo} />;
            case "actionGenerators":
              return <ActionGenerators db={db} navigateTo={navigateTo} />;
            case "reports":
              return <Reports db={db} navigateTo={navigateTo} />;
            case "topics":
              return <TopicsManager db={db} navigateTo={navigateTo} />;
            default:
              return <Home db={db} navigateTo={navigateTo} />;
          }
        };

        return (
          <div className="pb-24 min-h-screen bg-secondary-50 dark:bg-secondary-900 dark-mode">
            {renderView()}
            <BottomNav currentView={view} navigateTo={navigateTo} />
          </div>
        );
      }

      const domContainer = document.getElementById("app");
      const root = ReactDOM.createRoot(domContainer);
      root.render(<App />);
    </script>
    <script>
      // Service worker registration
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/service-worker.js")
            .then((registration) => {
              console.log("ServiceWorker registration successful");
            })
            .catch((error) => {
              console.log("ServiceWorker registration failed:", error);
            });
        });
      }
    </script>
  </body>
</html>
